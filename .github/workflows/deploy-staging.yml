# =============================================================================
# Deploy — Staging (auto on every merge to main)
# =============================================================================
#
# WHAT THIS DOES:
#   1. Builds the React SPA with staging environment variables
#   2. Deploys SPA to Cloudflare Pages (staging channel)
#   3. SSH into Cloudways staging server → git pull → composer → artisan
#   4. Purges Cloudflare cache so users get the new version immediately
#   5. Runs a smoke test to confirm both SPA and API are responding
#
# SETUP REQUIRED (one-time):
#   GitHub → Settings → Secrets → Actions:
#     CLOUDFLARE_API_TOKEN      - CF API token (Pages + Cache Purge permissions)
#     CLOUDFLARE_ACCOUNT_ID     - Your CF account ID
#
#   GitHub → Settings → Environments → staging → Secrets:
#     STAGING_SSH_HOST          - Cloudways server IP
#     STAGING_SSH_USER          - SSH username (from Cloudways SSH tab)
#     STAGING_SSH_PORT          - SSH port (usually 22)
#     STAGING_SSH_KEY           - Full PEM contents of your deploy private key
#     STAGING_APP_PATH          - App root, e.g. /home/master/applications/xxx/public_html
#
#   GitHub → Settings → Environments → staging → Variables:
#     APP_URL                   - https://staging.datatoolspro.com
#     VITE_API_URL              - https://staging.datatoolspro.com/api
#
#   GitHub → Settings → Variables (repo-level):
#     CLOUDFLARE_PAGES_PROJECT  - Your CF Pages project name, e.g. dtp-spa-poc
#     CLOUDFLARE_ZONE_ID        - Your domain Zone ID from CF dashboard
#
# SSH KEY SETUP:
#   See docs/SECRETS.md → "SSH Key Setup for Cloudways Deploy"
# =============================================================================

name: Deploy — Staging

on:
  push:
    branches: [main]

concurrency:
  group: deploy-staging
  cancel-in-progress: true

jobs:
  # ---------------------------------------------------------------------------
  # Job 1: Build the React SPA
  # ---------------------------------------------------------------------------
  build-dtp:
    name: Build SPA (Staging)
    runs-on: ubuntu-latest
    outputs:
      artifact-name: dtp-staging-${{ github.sha }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: dtp/package-lock.json

      - name: Install dependencies
        working-directory: dtp
        run: npm ci

      - name: Build SPA (staging config)
        working-directory: dtp
        run: npm run build
        env:
          NODE_ENV: production
          VITE_API_URL: ${{ vars.VITE_API_URL }}
          VITE_APP_ENV: staging
          VITE_APP_NAME: "DataTools Pro (Staging)"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: dtp-staging-${{ github.sha }}
          path: dtp/dist/
          retention-days: 30

  # ---------------------------------------------------------------------------
  # Job 2: Deploy SPA to Cloudflare Pages (staging channel)
  # ---------------------------------------------------------------------------
  deploy-dtp:
    name: Deploy SPA → Cloudflare Pages
    runs-on: ubuntu-latest
    needs: build-dtp
    environment:
      name: staging
      url: ${{ vars.APP_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download SPA build
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build-dtp.outputs.artifact-name }}
          path: dtp/dist/

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dtp/dist/ --project-name=${{ vars.CLOUDFLARE_PAGES_PROJECT }} --branch=staging

  # ---------------------------------------------------------------------------
  # Job 3: Deploy Laravel API to Cloudways staging server via SSH
  # ---------------------------------------------------------------------------
  deploy-api:
    name: Deploy API → Cloudways Staging
    runs-on: ubuntu-latest
    needs: build-dtp
    environment:
      name: staging
      url: ${{ vars.APP_URL }}

    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.STAGING_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ secrets.STAGING_SSH_PORT }} ${{ secrets.STAGING_SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Deploy to Cloudways (SSH)
        run: |
          ssh -i ~/.ssh/deploy_key \
              -p ${{ secrets.STAGING_SSH_PORT }} \
              -o StrictHostKeyChecking=no \
              ${{ secrets.STAGING_SSH_USER }}@${{ secrets.STAGING_SSH_HOST }} \
              "
              set -e
              echo '--- Navigating to app directory ---'
              cd ${{ secrets.STAGING_APP_PATH }}

              echo '--- Pulling latest code ---'
              git pull origin main

              echo '--- Installing PHP dependencies ---'
              composer install --no-interaction --no-dev --prefer-dist --optimize-autoloader

              echo '--- Running database migrations ---'
              php artisan migrate --force --no-interaction

              echo '--- Clearing and rebuilding caches ---'
              php artisan config:cache
              php artisan route:cache
              php artisan view:cache
              php artisan event:cache

              echo '--- Restarting queue workers ---'
              php artisan queue:restart

              echo '--- Deploy complete ---'
              "

      - name: Clean up SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key

  # ---------------------------------------------------------------------------
  # Job 4: Purge Cloudflare cache
  # ---------------------------------------------------------------------------
  purge-cache:
    name: Purge Cloudflare Cache
    runs-on: ubuntu-latest
    needs: [deploy-dtp, deploy-api]

    steps:
      - name: Purge Cloudflare zone cache
        run: |
          curl -s -X POST \
            "https://api.cloudflare.com/client/v4/zones/${{ vars.CLOUDFLARE_ZONE_ID }}/purge_cache" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{"purge_everything": true}' \
            | jq '.success'

  # ---------------------------------------------------------------------------
  # Job 5: Smoke test — confirm both SPA and API are alive
  # ---------------------------------------------------------------------------
  smoke-test:
    name: Smoke Test
    runs-on: ubuntu-latest
    needs: purge-cache

    steps:
      - name: Wait for propagation
        run: sleep 15

      - name: Check SPA is responding
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ vars.APP_URL }}")
          echo "SPA status: $STATUS"
          if [ "$STATUS" != "200" ]; then
            echo "SPA smoke test FAILED (HTTP $STATUS)"
            exit 1
          fi
          echo "SPA OK"

      - name: Check API health endpoint
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ vars.VITE_API_URL }}/health")
          echo "API status: $STATUS"
          if [ "$STATUS" != "200" ]; then
            echo "API health check FAILED (HTTP $STATUS) -- add a /api/health route to Laravel"
          fi

      - name: Staging deploy complete
        run: |
          echo "=========================================="
          echo "  STAGING DEPLOY COMPLETE"
          echo "  SHA:  ${{ github.sha }}"
          echo "  URL:  ${{ vars.APP_URL }}"
          echo "=========================================="
