# =============================================================================
# Deploy ‚Äî Staging (auto on every merge to main)
# =============================================================================
# Trigger: push to main (i.e., every merged PR)
#
# Strategy:
#   - Build SPA ‚Üí upload artifact
#   - Deploy to staging environment automatically (no approval gate)
#   - The SAME artifact will later be promoted to production
#
# Environment: "staging" (configure in GitHub ‚Üí Settings ‚Üí Environments)
#   Protections: none (auto-deploy)
#   Secrets needed: see step env: blocks below
#
# Replace the deploy steps with your actual hosting provider commands.
# Common options:
#   - Laravel Forge: use forge-deploy action or SSH + artisan
#   - Fly.io: flyctl deploy
#   - AWS: eb deploy / ECS / S3 + CloudFront
#   - Vercel / Netlify: their respective GitHub Actions
# =============================================================================

name: Deploy ‚Äî Staging

on:
  push:
    branches: [main]

concurrency:
  group: deploy-staging
  cancel-in-progress: true   # Cancel in-flight staging deploys on new push

jobs:
  # ---------------------------------------------------------------------------
  # Build SPA artifact (same artifact promoted to production later)
  # ---------------------------------------------------------------------------
  build-spa:
    name: Build SPA
    runs-on: ubuntu-latest
    outputs:
      artifact-name: ${{ steps.set-artifact.outputs.name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: spa/package-lock.json

      - name: Install SPA dependencies
        working-directory: spa
        run: npm ci

      - name: Build SPA
        working-directory: spa
        run: npm run build --if-present || echo "No build script yet"
        env:
          NODE_ENV: production
          VITE_API_URL: ${{ vars.STAGING_API_URL }}      # GitHub variable (non-secret)

      - name: Set artifact name
        id: set-artifact
        run: echo "name=spa-build-${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: spa-build-${{ github.sha }}
          path: spa/dist/
          if-no-files-found: ignore
          retention-days: 30    # keep 30 days ‚Äî used for production promotion

  # ---------------------------------------------------------------------------
  # Deploy to Staging
  # ---------------------------------------------------------------------------
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-spa
    environment:
      name: staging
      url: ${{ vars.STAGING_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build-spa.outputs.artifact-name }}
          path: spa/dist/

      # -----------------------------------------------------------------------
      # TODO: Replace this block with your actual deploy command
      # -----------------------------------------------------------------------
      - name: Deploy SPA to staging
        run: |
          echo "üöÄ Deploying SPA to staging..."
          echo "Commit: ${{ github.sha }}"
          echo "Built artifact: ${{ needs.build-spa.outputs.artifact-name }}"
          # Example (Fly.io):  flyctl deploy --remote-only
          # Example (SSH):     rsync -avz spa/dist/ user@staging-server:/var/www/html/
          # Example (S3):      aws s3 sync spa/dist/ s3://your-staging-bucket/ --delete
          echo "‚ö†Ô∏è  Deploy step not configured yet ‚Äî add your deploy command here."
        env:
          # Add secrets in GitHub ‚Üí Settings ‚Üí Environments ‚Üí staging ‚Üí Secrets
          DEPLOY_TOKEN: ${{ secrets.STAGING_DEPLOY_TOKEN }}

      - name: Deploy Laravel backend to staging
        run: |
          echo "üöÄ Deploying Laravel backend to staging..."
          # Example (Forge):   curl -X POST "${{ secrets.FORGE_DEPLOY_WEBHOOK }}"
          # Example (SSH):     ssh user@host "cd /var/www && git pull && composer install && php artisan migrate --force"
          echo "‚ö†Ô∏è  Backend deploy step not configured yet."
        env:
          DEPLOY_TOKEN: ${{ secrets.STAGING_DEPLOY_TOKEN }}

      - name: Post-deploy smoke test
        run: |
          echo "Running smoke test against ${{ vars.STAGING_URL }}..."
          # curl --fail "${{ vars.STAGING_URL }}/api/health" || exit 1
          echo "‚ö†Ô∏è  Smoke test not configured yet ‚Äî add your health check URL."

      - name: Notify on success
        if: success()
        run: |
          echo "‚úÖ Staging deploy succeeded ‚Äî ${{ github.sha }}"
          # Optional: Post to Slack, Teams, etc.

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Staging deploy FAILED ‚Äî ${{ github.sha }}"
          # Optional: Post to Slack, Teams, etc.
